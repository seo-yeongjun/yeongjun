<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{coffeeGame/layout}">
<head>
    <title th:text="${title} ?: 'ë‹¹ê·¼ ê¸°ë¥´ê¸° ğŸ¥•'"></title>
    <style>
        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 768px) {
            .input-container {
                flex-direction: column;
                gap: 1rem;
            }
            #nameList {
                width: 100% !important;
                padding: 0 !important;
            }
        }
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: relative;
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            text-align: center;
        }
        .modal-message {
            font-size: 1.2rem;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .modal-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s;
        }
        .modal-button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <!-- ì„¤ì • ì˜ì—­ -->
    <div id="settingBoard" class="container mx-auto py-8">
        <div class="flex justify-center items-center">
            <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-md flex flex-col items-center">
                <h1 class="text-2xl">ë‹¹ê·¼ ê¸°ë¥´ê¸° ğŸ¥•</h1>
                <div class="flex items-center space-x-2 mb-4">
                    <label for="playerCount" class="font-medium text-gray-700">ì°¸ê°€ì ìˆ˜</label>
                    <button id="minusBtn" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 transition duration-200 focus:outline-none">-</button>
                    <input type="number" id="playerCount" class="w-16 text-center border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500" value="4" min="1" max="10">
                    <button id="plusBtn" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 transition duration-200 focus:outline-none">+</button>
                    <button id="playerCountBtn" class="bg-blue-500 text-white px-4 py-1 rounded hover:bg-blue-600 transition duration-200 focus:outline-none">ì ìš©/ì´ˆê¸°í™”</button>
                </div>
                <div id="labelArea" class="hidden w-full">
                    <div class="flex flex-col items-center space-y-2">
                        <div id="nameList" class="w-full">
                            <!-- JSì—ì„œ ë™ì  ìƒì„± -->
                        </div>
                    </div>
                </div>
                <div class="mt-4 hidden" id="gameBtnArea">
                    <button id="startGame" class="bg-green-500 text-white px-4 py-1 rounded hover:bg-green-600 transition duration-200 focus:outline-none mr-2">ê²Œì„ ì‹œì‘</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ê²Œì„ ë³´ë“œ -->
    <div id="gameBoard" class="md:max-w-[82vw] hidden mx-auto mt-4 bg-white rounded-lg shadow-md">
        <div class="flex justify-center mb-4">
            <button id="resetGame" class="bg-red-500 text-white px-4 py-1 rounded hover:bg-red-600 transition duration-200 focus:outline-none">ì´ˆê¸°í™”</button>
        </div>
        <div class="overflow-x-auto">
            <canvas id="gameCanvas" class="mx-auto h-[50vh] border border-gray-300"></canvas>
        </div>
    </div>

    <!-- ê²Œì„ ì‹œì‘ ëª¨ë‹¬ -->
    <div id="gameModal" class="modal">
        <div class="modal-content">
            <div class="modal-message">
                ëˆ„êµ¬ì˜ ë‹¹ê·¼ì´ ê°€ì¥ í¬ê²Œ ìëì„ê¹Œìš”?
                ê°€ì¥ í° ë‹¹ê·¼ì„ ê¸°ë¥¸ í”Œë ˆì´ì–´ê°€ ê¸°ë¶„ ì¢‹ê²Œ ì»¤í”¼ë¥¼ ì©ë‹ˆë‹¤!
            </div>
            <button id="startCarrotGame" class="modal-button">ë‹¹ê·¼ ê¸°ë¥´ê¸°!</button>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let ctx, gameCanvas, canvasWidth, canvasHeight;
        // ì „ì²´ ë§µ ë†’ì´ë¥¼ 4ë°°ë¡œ ì„¤ì • (ìš°ì£¼, í•˜ëŠ˜, ëŒ€ê¸°/êµ¬ë¦„, ë•…)
        let totalMapHeight;
        // ì´ˆê¸° ì˜¤í”„ì…‹ (ë•…ë§Œ ë³´ì´ë„ë¡) = 3 * canvasHeight
        let initialOffset;

        let playerCount = 0;
        let playerNames = [];
        let carrotSizes = [];
        let animationFrame;
        let startTime;

        let stars = [];
        let birds = [];
        let clouds = [];

        function initBackgroundElements() {
            // ë³„ 50ê°œ ì¢Œí‘œ
            stars = [];
            for (let i = 0; i < 50; i++) {
                stars.push({
                    x: Math.random() * canvasWidth,
                    y: Math.random() * canvasHeight,
                    size: Math.random() * 2
                });
            }
            // ìƒˆ 5ë§ˆë¦¬ ì¢Œí‘œ
            birds = [];
            for (let i = 0; i < 5; i++) {
                birds.push({
                    x: Math.random() * canvasWidth,
                    y: canvasHeight + Math.random() * canvasHeight * 0.5
                });
            }
            // êµ¬ë¦„ 5ê°œ ì¢Œí‘œ (ëŒ€ê¸° ì˜ì—­)
            clouds = [];
            for (let i = 0; i < 5; i++) {
                clouds.push({
                    x: Math.random() * canvasWidth,
                    y: 2 * canvasHeight + Math.random() * canvasHeight,
                    scale: 1 + Math.random() * 0.5
                });
            }
        }

        // ì• ë‹ˆë©”ì´ì…˜ ë‹¨ê³„ ì‹œê°„
        const GROW_DURATION = 500;     // 0.5ì´ˆ (ë‹¹ê·¼ ì„±ì¥)
        const SCROLL_DURATION = 8000;   // 8ì´ˆ (ì¹´ë©”ë¼ ìŠ¤í¬ë¡¤)
        const TOTAL_DURATION = GROW_DURATION + SCROLL_DURATION; // ì´ 6ì´ˆ

        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        function initCanvas() {
            gameCanvas = document.getElementById('gameCanvas');
            ctx = gameCanvas.getContext('2d');

            // ìº”ë²„ìŠ¤ì˜ widthë¥¼ gameBoardì˜ widthë¡œ ì„¤ì •
            canvasWidth = document.getElementById('gameBoard').offsetWidth;
            // heightëŠ” ê¸°ì¡´ì²˜ëŸ¼ offsetHeight ë˜ëŠ” ì›í•˜ëŠ” ê°’ìœ¼ë¡œ ì„¤ì • ê°€ëŠ¥ (ì˜ˆ: window.innerHeightë‚˜ 50vh ë“±)
            canvasHeight = gameCanvas.offsetHeight;
            gameCanvas.width = canvasWidth;
            gameCanvas.height = canvasHeight;

            // ì „ì²´ ë§µ ë†’ì´ ë° ì´ˆê¸° ì˜¤í”„ì…‹ ì„¤ì •
            totalMapHeight = 4 * canvasHeight;
            initialOffset = 3 * canvasHeight;

            // ìº”ë²„ìŠ¤ í¬ê¸°ê°€ ê²°ì •ëœ í›„, ë°°ê²½ ìš”ì†Œ ì´ˆê¸°í™”
            initBackgroundElements();
        }

        // ë°°ê²½ ê·¸ë¦¬ê¸°
        // 0 ~ 1*canvasHeight: ìš°ì£¼, 1~2: í•˜ëŠ˜, 2~3: ëŒ€ê¸°/êµ¬ë¦„, 3~4: ë•…
        function drawBackground(offsetY) {
            ctx.save();
            ctx.translate(0, -offsetY);

            // ìš°ì£¼
            ctx.fillStyle = '#000033';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            // ë³„ íš¨ê³¼ (ë¯¸ë¦¬ ì €ì¥ëœ ì¢Œí‘œ ì‚¬ìš©)
            for (let star of stars) {
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
            }

            // í•˜ëŠ˜
            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, canvasHeight, canvasWidth, canvasHeight);

            // í•´(íƒœì–‘) ì¶”ê°€ - ìš°ì¸¡ ìƒë‹¨ì— ìœ„ì¹˜
            let sunX = canvasWidth - 100;
            let sunY = canvasHeight + 80; // í•˜ëŠ˜ ì˜ì—­ ë‚´
            let sunRadius = 40;
            let sunGradient = ctx.createRadialGradient(sunX, sunY, sunRadius * 0.2, sunX, sunY, sunRadius);
            sunGradient.addColorStop(0, 'yellow');
            sunGradient.addColorStop(1, 'orange');
            ctx.fillStyle = sunGradient;
            ctx.beginPath();
            ctx.arc(sunX, sunY, sunRadius, 0, Math.PI * 2);
            ctx.fill();

            // í•˜ëŠ˜ì— ìƒˆë“¤ ì¶”ê°€ (ë¯¸ë¦¬ ì €ì¥ëœ ì¢Œí‘œ ì‚¬ìš©)
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            for (let bird of birds) {
                ctx.beginPath();
                ctx.moveTo(bird.x, bird.y);
                ctx.lineTo(bird.x + 10, bird.y - 10);
                ctx.lineTo(bird.x + 20, bird.y);
                ctx.stroke();
            }

            // ëŒ€ê¸°/êµ¬ë¦„ (ê°„ë‹¨íˆ íŒŒë€ìƒ‰ í†¤)
            ctx.fillStyle = '#99CCFF';
            ctx.fillRect(0, 2 * canvasHeight, canvasWidth, canvasHeight);

            // ëŒ€ê¸° ìš”ì†Œ: êµ¬ë¦„ ì¶”ê°€ (ë¯¸ë¦¬ ì €ì¥ëœ ì¢Œí‘œ ì‚¬ìš©)
            for (let cloud of clouds) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(cloud.x, cloud.y, 20 * cloud.scale, 0, Math.PI * 2);
                ctx.arc(cloud.x + 25 * cloud.scale, cloud.y - 10 * cloud.scale, 15 * cloud.scale, 0, Math.PI * 2);
                ctx.arc(cloud.x + 40 * cloud.scale, cloud.y, 20 * cloud.scale, 0, Math.PI * 2);
                ctx.fill();
            }

            // ë•…
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(0, 3 * canvasHeight, canvasWidth, canvasHeight);
            // ë•… ì§ˆê° í‘œí˜„: ì‘ì€ ì ë“¤ (ì—¬ì „íˆ ë§¤ í”„ë ˆì„ ëœë¤ ìƒì„±í•´ë„ ê´œì°®ìŒ)
            for (let i = 0; i < 300; i++) {
                let x = Math.random() * canvasWidth;
                let y = 3 * canvasHeight + Math.random() * canvasHeight;
                let radius = Math.random() * 2;
                ctx.fillStyle = 'rgba(100, 50, 0, 0.6)';
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fill();
            }

            ctx.restore();
        }


        // ë‹¹ê·¼ ê·¸ë¦¬ê¸° í•¨ìˆ˜
        // x: ê°€ë¡œ ìœ„ì¹˜
        // targetLength: ë‹¹ê·¼ì˜ ìµœì¢… ê¸¸ì´ (í”½ì…€ ë‹¨ìœ„)
        // name: í”Œë ˆì´ì–´ ëª…ì¹­
        // growthProgress: 0~1 (ì„±ì¥ ë‹¨ê³„, 1ì´ë©´ full ê¸¸ì´)
        // offsetY: ë°°ê²½ ìŠ¤í¬ë¡¤ ì˜¤í”„ì…‹
        function drawCarrot(x, targetLength, name, growthProgress, offsetY) {
            const groundTop = 3 * canvasHeight;  // ë•… ìœ—ë¶€ë¶„
            const currentLength = growthProgress * targetLength;
            const virtualTop = groundTop - currentLength;
            const canvasBaseY = groundTop - offsetY;
            const canvasTopY  = virtualTop - offsetY;

            // ë‹¹ê·¼ ëª¸í†µ
            ctx.beginPath();
            ctx.moveTo(x, canvasBaseY);
            ctx.lineTo(x, canvasTopY);
            ctx.strokeStyle = '#FF6B6B';
            ctx.lineWidth = 3;
            ctx.stroke();

            // ë‹¹ê·¼ ì
            ctx.beginPath();
            ctx.moveTo(x, canvasTopY);
            ctx.quadraticCurveTo(x - 10, canvasTopY - 20, x, canvasTopY - 30);
            ctx.quadraticCurveTo(x + 10, canvasTopY - 20, x, canvasTopY);
            ctx.fillStyle = '#4CAF50';
            ctx.fill();

            // í”Œë ˆì´ì–´ ëª…ì°°
            ctx.fillStyle = '#FFF';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(name, x, canvasTopY - 10);
        }

        // ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„
        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const elapsed = timestamp - startTime;

            let offsetY = initialOffset;
            let growthProgress = 0;

            if (elapsed <= GROW_DURATION) {
                // Phase 1: ë‹¹ê·¼ ì„±ì¥ (ë°°ê²½ ê³ ì •)
                growthProgress = elapsed / GROW_DURATION;
            } else {
                // ì„±ì¥ ì™„ë£Œ
                growthProgress = 1;
            }

            if (elapsed > GROW_DURATION) {
                // Phase 2: ì¹´ë©”ë¼ ìŠ¤í¬ë¡¤ (2~6ì´ˆ)
                const scrollElapsed = elapsed - GROW_DURATION;
                const scrollProgress = Math.min(scrollElapsed / SCROLL_DURATION, 1);
                offsetY = initialOffset * (1 - scrollProgress);
            }

            ctx.clearRect(0, 0, canvasWidth, canvasHeight);
            drawBackground(offsetY);

            const gap = canvasWidth / (playerCount + 1);
            for (let i = 0; i < playerCount; i++) {
                const x = gap * (i + 1);
                drawCarrot(x, carrotSizes[i], playerNames[i], growthProgress, offsetY);
            }

            if (elapsed < TOTAL_DURATION) {
                animationFrame = requestAnimationFrame(animate);
            } else {
                // ì• ë‹ˆë©”ì´ì…˜ ì¢…ë£Œ í›„ ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
                showResult();
            }
        }

        // ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showResult() {
            // ìŠ¹ë¦¬ì ê²°ì • (ê°€ì¥ ê¸´ ë‹¹ê·¼)
            const maxSize = Math.max(...carrotSizes);
            const winnerIndex = carrotSizes.indexOf(maxSize);
            const winnerName = playerNames[winnerIndex];

            // í˜„ì¬ í™”ë©´ì˜ ë°°ê²½ì€ ë§ˆì§€ë§‰ ìŠ¤í¬ë¡¤ ìƒíƒœ(offsetY = 0)
            // ê²°ê³¼ ë©”ì‹œì§€ë¥¼ ì˜¤ë²„ë ˆì´ë¡œ í‘œì‹œ
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

            let fontSize = 24;
            if (window.innerWidth < 768) { // 768px ì´í•˜ë¥¼ ëª¨ë°”ì¼ë¡œ íŒë‹¨
                fontSize = 14;
            }
            ctx.fillStyle = 'white';
            ctx.font = `bold ${fontSize}px sans-serif`;
            ctx.textAlign = 'center';
            const textY = canvasHeight * 0.5; // í™”ë©´ì˜ 3/4 ìœ„ì¹˜
            ctx.fillText(`${winnerName}ë‹˜ì˜ ë‹¹ê·¼ì´ ê°€ì¥ í¬ê²Œ ìëì–´ìš”.`, canvasWidth / 2, textY - 10);
            ctx.fillText(`ê¸°ë¶„ì¢‹ê²Œ ì»¤í”¼ë¥¼ ì©ì‹œë‹¤!`, canvasWidth / 2, textY + 20);
        }

        // ê²Œì„ ì´ˆê¸°í™”
        // ê° ë‹¹ê·¼ì˜ targetLengthëŠ” [canvasHeight, 2.5Ã—canvasHeight] ë²”ìœ„ì—ì„œ ê²°ì •í•˜ê³ ,
        // í•œ ë‹¹ê·¼ì€ ê°•ì œë¡œ 3Ã—canvasHeightë¡œ ì„¤ì •í•˜ì—¬ ìš°ì£¼ê¹Œì§€ ë„ë‹¬í•˜ë„ë¡ í•¨.
        function initGame() {
            carrotSizes = [];
            for (let i = 0; i < playerCount; i++) {
                const randLength = canvasHeight + Math.random() * (1.5 * canvasHeight);
                carrotSizes.push(randLength);
            }
            if (playerCount > 0) {
                const idx = Math.floor(Math.random() * playerCount);
                carrotSizes[idx] = 2.5 * canvasHeight;
            }
            startTime = null;
            animationFrame = requestAnimationFrame(animate);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.onload = () => {
            const playerCountInput = document.getElementById('playerCount');
            const playerCountBtn = document.getElementById('playerCountBtn');
            const nameList = document.getElementById('nameList');
            const labelArea = document.getElementById('labelArea');
            const gameBtnArea = document.getElementById('gameBtnArea');
            const startGame = document.getElementById('startGame');
            const settingBoard = document.getElementById('settingBoard');
            const gameBoard = document.getElementById('gameBoard');
            const resetGame = document.getElementById('resetGame');
            const plusBtn = document.getElementById('plusBtn');
            const minusBtn = document.getElementById('minusBtn');
            const gameModal = document.getElementById('gameModal');
            const startCarrotGame = document.getElementById('startCarrotGame');

            plusBtn.addEventListener('click', () => {
                playerCountInput.value = Math.min(parseInt(playerCountInput.value) + 1, 10);
            });
            minusBtn.addEventListener('click', () => {
                playerCountInput.value = Math.max(parseInt(playerCountInput.value) - 1, 1);
            });

            playerCountBtn.addEventListener('click', () => {
                playerCount = parseInt(playerCountInput.value);
                nameList.innerHTML = '<label class="font-medium text-gray-700 mb-2 block">í”Œë ˆì´ì–´ ì´ë¦„</label>';
                for (let i = 0; i < playerCount; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = `í”Œë ˆì´ì–´${i + 1}`;
                    input.className = 'w-full border border-gray-300 rounded px-2 py-1 mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500';
                    input.addEventListener('click', () => { input.value = ''; });
                    nameList.appendChild(input);
                }
                labelArea.classList.remove('hidden');
                gameBtnArea.classList.remove('hidden');
            });

            startGame.addEventListener('click', () => {
                const names = document.querySelectorAll('#nameList input');
                playerNames = Array.from(names).map(input => input.value.trim());
                if (playerNames.some(name => !name)) {
                    alert('ëª¨ë“  í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                settingBoard.classList.add('hidden');
                gameBoard.classList.remove('hidden');
                gameModal.style.display = 'block';
            });

            startCarrotGame.addEventListener('click', () => {
                gameModal.style.display = 'none';
                initCanvas();
                initGame();
            });

            resetGame.addEventListener('click', () => {
                window.location.reload();
            });
        };
    </script>
</div>
</body>
</html>
