<!DOCTYPE html>
<html
        xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
        layout:decorate="~{babfullmenu/layout}"
        lang="ko">
<head>
    <title th:text="'ì˜ì¤€ë‹·ì»´ | ë°¥fullì‹ë‹¨'">í™ˆ í˜ì´ì§€</title>
    <style>
        /* í…Œì´ë¸” ê³µí†µ ìŠ¤íƒ€ì¼ */
        table {
            table-layout: auto; /* ìë™ ë ˆì´ì•„ì›ƒ (ëª¨ë°”ì¼ ëŒ€ì‘) */
            margin: 0 auto; /* ê°€ìš´ë° ì •ë ¬ */
            border-collapse: collapse;
            width: 95%; /* í­ì„ ë„“ê²Œ ì¡°ì ˆ */
            background-color: #FFFFFF;
            /* ì‚´ì§ ê·¸ë¦¼ì íš¨ê³¼ */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            /* í…Œë‘ë¦¬ ìƒ‰ìƒ */
            border: 1px solid #E5E7EB;
        }

        /* ë°ìŠ¤í¬í†±ì—ì„œëŠ” ê³ ì • ë ˆì´ì•„ì›ƒ ì‚¬ìš© */
        @media (min-width: 769px) {
            table {
                table-layout: fixed;
                width: 95%;
            }

            th, td {
                padding: 0.4rem 0.3rem;
            }

            .auto-resize {
                font-size: 13px;
            }

            .menu-item-container {
                gap: 2px;
            }

            .menu-name {
                line-height: 1.2;
            }

            .menu-vote-container {
                gap: 4px;
                margin-top: 1px;
                padding: 1px 0;
            }

            .vote-btn {
                padding: 2px 5px;
                font-size: 9px;
                min-width: 35px;
                gap: 2px;
            }

            .vote-emoji {
                font-size: 10px;
            }

            tr.breakfast-header > td,
            tr.lunch-header > td {
                padding: 0.25rem 0.3rem;
                font-size: 11px;
            }

            /* í˜ì´ì§€ ì „ì²´ ë†’ì´ ìµœì í™” */
            .text-center {
                margin-top: 0.5rem;
                margin-bottom: 0.5rem;
            }
        }

        /* íƒœë¸”ë¦¿ ìŠ¤íƒ€ì¼ */
        @media (min-width: 481px) and (max-width: 768px) {
            table {
                width: 98%;
            }

            th, td {
                padding: 0.3rem 0.2rem;
            }

            .auto-resize {
                font-size: 11px;
            }

            .vote-btn {
                padding: 2px 4px;
                font-size: 8px;
                min-width: 30px;
            }

            .vote-emoji {
                font-size: 9px;
            }

            tr.breakfast-header > td,
            tr.lunch-header > td {
                padding: 0.25rem 0.2rem;
                font-size: 10px;
            }
        }

        thead tr {
            /* í—¤ë”ëŠ” ì¡°ê¸ˆ ë” ì§„í•œ ë°°ê²½ */
            background-color: #F3F4F6;
        }

        th, td {
            border: 1px solid #E5E7EB;
            padding: 0.5rem 0.4rem;
            text-align: center;
            white-space: normal; /* ëª¨ë°”ì¼ì—ì„œ ì¤„ë°”ê¿ˆ í—ˆìš© */
            font-weight: normal; /* ê¸°ë³¸ í°íŠ¸ êµµê¸° */
            vertical-align: middle;
            word-break: keep-all; /* ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì¤„ë°”ê¿ˆ */
        }

        /* ì§ìˆ˜ í–‰ì— ì‚´ì§ ë‹¤ë¥¸ ë°°ê²½ìƒ‰ (í…Œì´ë¸”ì— ì¤„ë¬´ëŠ¬ íš¨ê³¼) */
        tbody tr:nth-child(even) {
            background-color: #F9FAFB;
        }

        /* auto-resize ê³µí†µ í´ë˜ìŠ¤ */
        .auto-resize {
            font-size: 14px; /* ê¸°ë³¸ í°íŠ¸ ì‚¬ì´ì¦ˆ */
            vertical-align: middle; /* ì„¸ë¡œ ì •ë ¬ */
        }

        /* ì¡°ì‹ êµ¬ë¶„ í–‰ - íŒŒìŠ¤í…” ì˜¤ë Œì§€ í†¤ */
        tr.breakfast-header > td {
            background-color: #ddc2c2;
            font-weight: 600; /* êµ¬ë¶„ í–‰ì€ ì•½ê°„ ë‘ê»ê²Œ */
            padding: 0.4rem 0.4rem;
            font-size: 13px;
        }
        /* ì¤‘ì‹ êµ¬ë¶„ í–‰ - íŒŒìŠ¤í…” ê·¸ë¦° í†¤ */
        tr.lunch-header > td {
            background-color: #bcdfbc;
            font-weight: 600;
            padding: 0.4rem 0.4rem;
            font-size: 13px;
        }

        /* ì œê³µì ë¬¸êµ¬ ìƒ‰ìƒ(ì›ë˜ text-green-500 ì‚¬ìš© ì¤‘) */
        .provider-text {
            color: #ea7f06; /* Tailwindì˜ emerald-500 ì¯¤ ë˜ëŠ” ì»¬ëŸ¬ */
        }

        /* ë©”ë‰´ ì•„ì´í…œ ì»¨í…Œì´ë„ˆ */
        .menu-item-container {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            gap: 3px;
        }

        .menu-name {
            margin-bottom: 0;
            word-break: keep-all;
            line-height: 1.3;
        }

        /* ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ëª…ê³¼ ì¢‹ì•„ìš”/ì‹«ì–´ìš”ë¥¼ ê°™ì€ ì¤„ì— ë°°ì¹˜ */
        @media (max-width: 768px) {
            .menu-item-container {
                flex-direction: column;
                flex-wrap: nowrap;
                justify-content: center;
                gap: 4px;
                align-items: center;
                cursor: pointer;
                position: relative;
            }

            .menu-name {
                margin-bottom: 0;
                text-align: center;
                width: 100%;
            }

            /* ëª¨ë°”ì¼ì—ì„œ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ê¸°ë³¸ ìˆ¨ê¹€ */
            .menu-vote-container {
                display: none !important;
                flex: 0 0 auto;
                margin-top: 0;
                width: 100%;
                justify-content: center;
            }

            /* í´ë¦­ ì‹œ í‘œì‹œë˜ëŠ” í´ë˜ìŠ¤ */
            .menu-item-container.show-votes .menu-vote-container {
                display: flex !important;
                animation: fadeIn 0.3s ease-in;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(-5px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        }

        /* ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .menu-vote-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 2px;
            padding: 2px 0;
        }

        /* ë°ìŠ¤í¬íƒ‘/íƒœë¸”ë¦¿ì—ì„œëŠ” í•­ìƒ í‘œì‹œ */
        @media (min-width: 769px) {
            .menu-vote-container {
                display: flex !important;
            }
        }

        .vote-btn {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            padding: 3px 6px;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 2px;
            transition: all 0.2s ease;
            min-width: 40px;
            justify-content: center;
            font-weight: 500;
            color: #374151;
        }

        .vote-btn:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .vote-btn:active {
            transform: translateY(0);
        }

        .vote-btn.like-btn.active {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
            font-weight: 600;
        }

        .vote-btn.dislike-btn.active {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
            font-weight: 600;
        }

        .vote-separator {
            margin: 0 4px;
            color: #9ca3af;
            font-weight: 300;
        }

        .vote-emoji {
            font-size: 11px;
            line-height: 1;
            display: inline-block;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        @media (max-width: 768px) {
            /* í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ - ê°€ë¡œ ìŠ¤í¬ë¡¤ ì œê±° */
            .text-center > div {
                overflow-x: visible;
                width: 100%;
                margin: 0 auto;
            }

            table {
                width: 100% !important;
                font-size: 11px;
                min-width: 0 !important; /* ìµœì†Œ ë„ˆë¹„ ì œê±° */
                table-layout: auto; /* ìë™ ë ˆì´ì•„ì›ƒ */
                max-width: 100%;
            }

            th, td {
                padding: 0.4rem 0.15rem;
                font-size: 10px;
                width: auto !important;
                max-width: 20vw; /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
                min-width: 0;
            }

            .menu-item-container {
                gap: 2px;
                min-height: auto;
            }

            .menu-name {
                font-size: 10px;
                line-height: 1.2;
                margin-bottom: 2px;
            }

            .menu-vote-container {
                gap: 3px;
                padding: 2px 0;
                flex-wrap: nowrap;
            }

            .vote-btn {
                padding: 2px 4px;
                font-size: 8px;
                min-width: 28px;
                max-width: 35px;
                gap: 1px;
                border-radius: 4px;
                white-space: nowrap;
                overflow: hidden;
            }

            .vote-btn .vote-emoji {
                font-size: 10px;
            }

            .vote-btn .like-count,
            .vote-btn .dislike-count {
                font-size: 8px;
            }

            .vote-emoji {
                font-size: 11px;
            }

            .vote-separator {
                margin: 0 1px;
                font-size: 9px;
            }

            /* ì œê³µì í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
            .provider-text {
                font-size: 16px;
            }

            /* í…Œì´ë¸” í—¤ë”ë„ ì‘ê²Œ */
            th.auto-resize {
                font-size: 10px;
                padding: 0.3rem 0.2rem;
            }
        }

        /* ì‘ì€ ëª¨ë°”ì¼ (480px ì´í•˜) */
        @media (max-width: 480px) {
            table {
                width: 100% !important;
                min-width: 0 !important;
                font-size: 10px;
                max-width: 100%;
            }

            th, td {
                padding: 0.3rem 0.1rem;
                font-size: 9px;
                max-width: 18vw; /* ì‘ì€ ëª¨ë°”ì¼ì—ì„œ ë” ì‘ê²Œ */
                min-width: 0;
            }

            .menu-name {
                font-size: 9px;
                line-height: 1.2;
            }

            .menu-vote-container {
                gap: 2px;
            }

            .vote-btn {
                padding: 2px 3px;
                font-size: 7px;
                min-width: 25px;
                max-width: 30px;
                gap: 1px;
                white-space: nowrap;
            }

            .vote-btn .vote-emoji {
                font-size: 9px;
            }

            .vote-btn .like-count,
            .vote-btn .dislike-count {
                font-size: 7px;
            }

            .vote-emoji {
                font-size: 10px;
            }

            .vote-separator {
                font-size: 8px;
                margin: 0 1px;
            }

            .provider-text {
                font-size: 14px;
            }

            th.auto-resize {
                font-size: 9px;
                padding: 0.25rem 0.15rem;
            }
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div id="loadingSpinner"
         class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
        <!-- íšŒì „í•˜ëŠ” ì› ëª¨ì–‘ -->
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <p class="ml-4 text-white font-medium">ì—…ë¡œë“œ ì¤‘...</p>
    </div>
    <div th:if="${error}" id="errorModal" class="fixed inset-0 flex items-center justify-center z-50">
        <!-- Background Overlay -->
        <div class="absolute inset-0 bg-black opacity-50"></div>
        <!-- Modal Content -->
        <div class="bg-white rounded-lg shadow-lg z-10 p-6 max-w-sm w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-red-600">ì˜¤ë¥˜</h3>
                <button onclick="closeModal('errorModal')" class="text-gray-600 hover:text-gray-800">&times;
                </button>
            </div>
            <p th:text="${error}"></p>
            <div class="mt-4 text-right">
                <button onclick="closeModal('errorModal')"
                        class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>
    <!-- babfullmenu.size() == 0 ì¸ ê²½ìš°(= ì˜¤ëŠ˜ ë©”ë‰´ê°€ ë¹„ì–´ìˆì„ ë•Œ) -->
    <!-- í˜ì´ì§€ ì„¤ëª… -->
    <div class="text-center mb-2">
        <p class="mt-1 text-sm text-gray-600 underline">
           ì„±ê³µíšŒëŒ€í•™êµ ë°¥fullì˜ ì‹ë‹¨ì„ ì œê³µí•˜ëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.<br/>
        </p>
    </div>
    <div th:if="${babfullmenu.size() == 0}" class="text-center">
        <p class="mb-4 text-lg font-semibold text-red-500">
            ì•„ì§ ì´ë²ˆì£¼ ë©”ë‰´ë¥¼ ì—…ë¡œë“œí•œ ì‚¬ëŒì´ ì—†ì–´ìš”!<br/>
            ë©”ë‰´ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ ê¸°ì—¬í•´ì£¼ì„¸ìš”!
        </p>

        <!-- ì—…ë¡œë“œ í¼ ì‹œì‘ -->
        <form th:action="@{/babfullmenu/upload}"
              method="post"
              enctype="multipart/form-data"
              class="mx-auto w-full max-w-md p-6 border-4 border-dashed border-gray-300
                     rounded-xl bg-white relative"
              ondragover="handleDragOver(event)"
              ondrop="handleDrop(event)"
              id="uploadForm"
              onsubmit="showSpinner()">

            <!-- ì´ë¦„(provider) ì…ë ¥ í•„ë“œ -->
            <div class="mb-4">
                <label for="provider" class="block mb-2 font-medium text-gray-700">
                    ì´ë¦„:
                </label>
                <input type="text"
                       name="provider"
                       id="provider"
                       placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
                       class="w-full p-2 border border-gray-300 rounded-md"
                       required/>
            </div>

            <!-- ì‹¤ì œ íŒŒì¼ ì„ íƒ input -->
            <input type="file"
                   name="file"
                   id="fileInput"
                   class="hidden"
                   accept="image/*"
                   onchange="handleFileSelection(event)"/>

            <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ -->
            <div class="mb-4 p-6 bg-gray-50 rounded-md cursor-pointer"
                 id="dropZone"
                 onclick="document.getElementById('fileInput').click()">
                <p id="dropZoneText" class="text-gray-400">
                    ì—¬ê¸°ë¥¼ í´ë¦­í•˜ê±°ë‚˜, íŒŒì¼ì„ ëŒì–´ì˜¤ê±°ë‚˜,
                    ì´ë¯¸ì§€ë¥¼ ë³µì‚¬ í›„ <strong>Ctrl+V</strong>ë¡œ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <!-- ë¯¸ë¦¬ë³´ê¸°(ì¸ë„¤ì¼) ì˜ì—­ (ì´ˆê¸°ì— hidden) -->
            <div id="previewContainer" class="mb-4 hidden">
                <img id="previewImg" alt="ì„ íƒëœ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°" class="mx-auto h-48 object-contain"/>
                <p class="text-blue-500 mt-2 text-sm">
                    ì´ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
                </p>
            </div>

            <!-- ì—…ë¡œë“œ ë²„íŠ¼ -->
            <button type="submit"
                    class="block w-full py-2 bg-blue-500 text-white font-semibold
                           rounded-md hover:bg-blue-600"
                    id="uploadBtn"
                    disabled>
                ì—…ë¡œë“œ
            </button>
        </form>
        <!-- ì—…ë¡œë“œ í¼ ë -->
    </div>
    <!-- babfullmenu.size() > 0 ì¸ ê²½ìš°(= ì˜¤ëŠ˜ ë©”ë‰´ê°€ ìˆì„ ë•Œ) -->
    <div th:if="${babfullmenu.size() > 0}" class="text-center">
        <p class="mb-2 text-base font-semibold provider-text"
           th:text="'â˜…'+${babfullmenu[0].provider}+'â˜…'+'ë‹˜ì´ ì œê³µí•´ì£¼ì‹  ë©”ë‰´í‘œì…ë‹ˆë‹¤.'"></p>
        <div style="width: 100%;">
        <table class="w-full">
            <thead>
            <tr>
                <th class="auto-resize"
                    th:each="menuItem : ${babfullmenu}"
                    th:text="${#dates.format(menuItem.getFormatedMenuDt(), 'MM-dd(E)')}">
                    ë‚ ì§œ
                </th>
            </tr>
            </thead>
            <tbody>
            <!-- ì¡°ì‹ ë©”ë‰´ -->
            <tr class="breakfast-header">
                <td class="px-2 py-2 auto-resize" colspan="5">ì¡°ì‹</td>
            </tr>
            <tr th:each="i : ${#numbers.sequence(1,9)}" class="breakfast-row">
                <td class="px-2 py-2 w-[20%] auto-resize" th:each="menuItem : ${babfullmenu}">
                    <div class="menu-item-container">
                        <div class="menu-name" th:text="${#strings.isEmpty(menuItem['morning_menu' + i]) ? '' : menuItem['morning_menu' + i]}">
                        </div>
                        <div th:if="${!#strings.isEmpty(menuItem['morning_menu' + i])}" class="menu-vote-container" 
                             th:data-menu-name="${menuItem['morning_menu' + i]}"
                             th:data-menu-date="${#temporals.format(menuItem.menu_dt, 'yyyy-MM-dd')}">
                            <button class="vote-btn like-btn" data-vote-type="LIKE" title="ì¢‹ì•„ìš”">
                                <span class="vote-emoji">ğŸ‘</span> <span class="like-count">0</span>
                            </button>
                            <span class="vote-separator">/</span>
                            <button class="vote-btn dislike-btn" data-vote-type="DISLIKE" title="ì‹«ì–´ìš”">
                                <span class="vote-emoji">ğŸ‘</span> <span class="dislike-count">0</span>
                            </button>
                        </div>
                    </div>
                </td>
            </tr>
            <!-- ì ì‹¬ ë©”ë‰´ -->
            <tr class="lunch-header">
                <td class="px-2 py-2 auto-resize" colspan="5">ì¤‘ì‹</td>
            </tr>
            <tr th:each="i : ${#numbers.sequence(1,9)}" class="lunch-row">
                <td class="px-2 py-2 w-[20%] auto-resize" th:each="menuItem : ${babfullmenu}">
                    <div class="menu-item-container">
                        <div class="menu-name" th:text="${#strings.isEmpty(menuItem['lunch_menu' + i]) ? '' : menuItem['lunch_menu' + i]}">
                        </div>
                        <div th:if="${!#strings.isEmpty(menuItem['lunch_menu' + i])}" class="menu-vote-container" 
                             th:data-menu-name="${menuItem['lunch_menu' + i]}"
                             th:data-menu-date="${#temporals.format(menuItem.menu_dt, 'yyyy-MM-dd')}">
                            <button class="vote-btn like-btn" data-vote-type="LIKE" title="ì¢‹ì•„ìš”">
                                <span class="vote-emoji">ğŸ‘</span> <span class="like-count">0</span>
                            </button>
                            <span class="vote-separator">/</span>
                            <button class="vote-btn dislike-btn" data-vote-type="DISLIKE" title="ì‹«ì–´ìš”">
                                <span class="vote-emoji">ğŸ‘</span> <span class="dislike-count">0</span>
                            </button>
                        </div>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
        </div>
    </div>
    <script th:inline="javascript">
        /*[# th:if="${likeDislikeMap != null}"]*/
        const serverLikeDislikeMap = /*[[${likeDislikeMap}]]*/ {};
        const serverCurrentVoteMap = /*[[${currentVoteMap}]]*/ {};
        /*[/]*/
        
        function showSpinner() {
            // ìŠ¤í”¼ë„ˆë¥¼ í™”ë©´ì— í‘œì‹œ
            const spinner = document.getElementById('loadingSpinner');
            spinner.classList.remove('hidden');
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ë“œë˜ê·¸ ì˜ì—­ ì§„ì…ì‹œ ê¸°ë³¸ ì´ë²¤íŠ¸ ë°©ì§€
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // ë“œë¡­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            const files = e.dataTransfer.files;
            if (files && files.length > 0) {
                // ë‹¨ì¼ íŒŒì¼ë§Œ ì²˜ë¦¬
                setFile(files[0]);
            }
        }

        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸ ì²˜ë¦¬ (inputìœ¼ë¡œ ì§ì ‘ ì„ íƒí–ˆì„ ë•Œ)
        function handleFileSelection(e) {
            const file = e.target.files[0];
            if (file) {
                setFile(file);
            }
        }

        // ë¶™ì—¬ë„£ê¸°(Clipboard) ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.addEventListener('paste', function (e) {
            const clipboardFiles = e.clipboardData.files;
            if (clipboardFiles && clipboardFiles.length > 0) {
                setFile(clipboardFiles[0]);
            }
        });

        // ì‹¤ì œë¡œ íŒŒì¼ì„ ì„¸íŒ…í•˜ê³  ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function setFile(file) {
            // ì´ë¯¸ì§€ì¸ì§€ í™•ì¸ (MIME íƒ€ì…)
            if (!file.type.startsWith('image/')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            // inputì— íŒŒì¼ ì„¸íŒ…
            document.getElementById('fileInput').files = createFileList(file);

            // ì¸ë„¤ì¼ í‘œì‹œ
            previewImage(file);

            // ë“œë¡­ì˜ì—­ ë¹„í™œì„±í™” (ì¶”ê°€ ì„ íƒ ë¶ˆê°€ëŠ¥)
            disableDropZone();

            // ì—…ë¡œë“œ ë²„íŠ¼ í™œì„±í™”
            document.getElementById('uploadBtn').disabled = false;
        }

        // FileList ê°ì²´ë¥¼ ìƒì„±í•´ì„œ inputì— ì„¸íŒ…í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function createFileList(file) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            return dataTransfer.files;
        }

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (DataURL ì‚¬ìš©)
        function previewImage(file) {
            const previewContainer = document.getElementById('previewContainer');
            const previewImg = document.getElementById('previewImg');

            const reader = new FileReader();
            reader.onload = function (e) {
                previewImg.src = e.target.result;
                // ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ í‘œì‹œ
                previewContainer.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        // ì¶”ê°€ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì§€ ëª»í•˜ë„ë¡ ë“œë¡­ì˜ì—­ / ë¬¸êµ¬ ë¹„í™œì„±
        function disableDropZone() {
            const dropZone = document.getElementById('dropZone');
            dropZone.classList.add('hidden');
        }

        /**
         * í…Œì´ë¸” ë‚´ auto-resize í´ë˜ìŠ¤ë¥¼ ê°€ì§„ ì…€(td/th)ì— ëŒ€í•˜ì—¬
         * ë‚´ìš©ì´ ë„˜ì¹˜ë©´ í°íŠ¸ë¥¼ ì¤„ì´ëŠ” ë¡œì§.
         * - minFontSize, maxIteration ë“±ì„ ì¡°ì ˆí•´ë³¼ ìˆ˜ ìˆìŒ
         */
        function autoResizeText() {
            const cells = document.querySelectorAll('td.auto-resize, th.auto-resize');
            const minFontSize = 8;   // ì›í•˜ëŠ” ìµœì†Œ í°íŠ¸ í¬ê¸°
            const maxFontSize = 16;  // ì›í•˜ëŠ” ìµœëŒ€ í°íŠ¸ í¬ê¸° (í•„ìš” ì‹œ ì¡°ì •)

            cells.forEach(cell => {
                // (1) ì¼ë‹¨ ìµœì†Œ í°íŠ¸ í¬ê¸°ë¡œ ì„¤ì •
                let currentFontSize = minFontSize;
                cell.style.fontSize = currentFontSize + 'px';

                // (2) ì…€ì´ ë„˜ì¹˜ì§€ ì•Šê³  && ì•„ì§ ìµœëŒ€ì¹˜ì— ë„ë‹¬í•˜ì§€ ì•Šì•˜ë‹¤ë©´ ê³„ì† í°íŠ¸ë¥¼ 1ì”© ì˜¬ë¦¼
                while (cell.scrollWidth <= cell.clientWidth && currentFontSize < maxFontSize) {
                    currentFontSize++;
                    cell.style.fontSize = currentFontSize + 'px';
                }

                // (3) ìœ„ ë£¨í”„ë¥¼ ë¹ ì ¸ë‚˜ì™”ì„ ë•Œ, scrollWidthê°€ ì´ˆê³¼ëœ ìƒíƒœê±°ë‚˜ maxFontSizeë¥¼ ë„˜ì€ ìƒíƒœë©´
                //     ë°”ë¡œ ì§ì „ í¬ê¸°(1 ì¤„ì´ê¸°)ë¡œ ë˜ëŒë¦¼
                if (cell.scrollWidth > cell.clientWidth || currentFontSize > maxFontSize) {
                    currentFontSize--;
                    cell.style.fontSize = currentFontSize + 'px';
                }
            });
        }

        function removeEmptyRows() {
            // ì „ì²´ í…Œì´ë¸”ì—ì„œ <tbody> ë‚´ì˜ ëª¨ë“  <tr>ì„ ì¡°íšŒ
            const table = document.querySelector('table.w-full');
            if (!table) return;

            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                // (1) "ì¡°ì‹", "ì¤‘ì‹" êµ¬ë¶„ìš© í—¤ë”(tr)ì¸ì§€ ì²´í¬ (colspan=5 ë“±)
                //     -> ì´ëŸ° í—¤ë”ëŠ” ì œê±° ëŒ€ìƒì—ì„œ ì œì™¸
                const specialTd = row.querySelector('td[colspan="5"]');
                if (specialTd) {
                    return; // "ì¡°ì‹"/"ì¤‘ì‹" ë“± êµ¬ë¶„ RowëŠ” ë¬´ì¡°ê±´ ë‚¨ê¹€
                }

                // (2) ì¼ë°˜ ë©”ë‰´ rowë¼ë©´, ê° tdì˜ í…ìŠ¤íŠ¸ë¥¼ í™•ì¸
                const tds = row.querySelectorAll('td');
                // tdê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´(ì´ìƒí•œ ê²½ìš°) ê·¸ëƒ¥ return
                if (tds.length === 0) return;

                // ëª¨ë“  tdê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
                let allEmpty = true;
                tds.forEach(td => {
                    const text = td.textContent.trim();
                    if (text.length > 0) {
                        allEmpty = false;
                    }
                });

                // (3) ì „ë¶€ ë¹„ì–´ìˆìœ¼ë©´ í•´ë‹¹ tr ì œê±°
                if (allEmpty) {
                    row.remove();
                }
            });
        }

        // ì¿ í‚¤ ì½ê¸° í•¨ìˆ˜
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // ì¢‹ì•„ìš”/ì‹«ì–´ìš” íˆ¬í‘œ ì²˜ë¦¬
        async function handleVote(menuName, menuDate, voteType) {
            try {
                const formData = new FormData();
                formData.append('menuName', menuName);
                formData.append('menuDate', menuDate);
                formData.append('voteType', voteType);

                const response = await fetch('/babfullmenu/vote', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    throw new Error('íˆ¬í‘œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                const result = await response.json();
                return result;
            } catch (error) {
                console.error('íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                alert('íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return null;
            }
        }

        // ë©”ë‰´ë³„ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì´ˆê¸°í™”
        function initializeVotes() {
            const voteContainers = document.querySelectorAll('.menu-vote-container');
            
            // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ì‚¬ìš© (ê°œë³„ API í˜¸ì¶œ ì œê±°)
            for (const container of voteContainers) {
                const menuName = container.getAttribute('data-menu-name');
                const menuDate = container.getAttribute('data-menu-date');
                if (!menuName || menuName.trim() === '' || !menuDate) continue;

                const menuKey = `${menuDate}|${menuName}`;

                // ëª¨ë°”ì¼ìš© has-vote í´ë˜ìŠ¤ ì¶”ê°€
                const menuItemContainer = container.closest('.menu-item-container');
                if (menuItemContainer) {
                    menuItemContainer.classList.add('has-vote');
                }

                const likeBtn = container.querySelector('.like-btn');
                const dislikeBtn = container.querySelector('.dislike-btn');
                const likeCountSpan = container.querySelector('.like-count');
                const dislikeCountSpan = container.querySelector('.dislike-count');

                // ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ì‚¬ìš©
                let likeCount = 0;
                let dislikeCount = 0;
                let currentVote = null;
                
                if (typeof serverLikeDislikeMap !== 'undefined' && serverLikeDislikeMap[menuKey]) {
                    const likeDislike = serverLikeDislikeMap[menuKey];
                    likeCount = likeDislike && likeDislike.likeCount != null ? likeDislike.likeCount : 0;
                    dislikeCount = likeDislike && likeDislike.dislikeCount != null ? likeDislike.dislikeCount : 0;
                }
                
                if (typeof serverCurrentVoteMap !== 'undefined' && serverCurrentVoteMap[menuKey]) {
                    currentVote = serverCurrentVoteMap[menuKey];
                }
                
                likeCountSpan.textContent = likeCount;
                dislikeCountSpan.textContent = dislikeCount;
                
                // í˜„ì¬ íˆ¬í‘œ ìƒíƒœ ì„¤ì •
                if (currentVote === 'LIKE') {
                    likeBtn.classList.add('active');
                } else if (currentVote === 'DISLIKE') {
                    dislikeBtn.classList.add('active');
                }

                // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                likeBtn.addEventListener('click', async () => {
                    const result = await handleVote(menuName, menuDate, 'LIKE');
                    if (result) {
                        likeCountSpan.textContent = result.likeCount || 0;
                        dislikeCountSpan.textContent = result.dislikeCount || 0;
                        
                        // í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
                        if (result.currentVote === 'LIKE') {
                            likeBtn.classList.add('active');
                            dislikeBtn.classList.remove('active');
                        } else {
                            likeBtn.classList.remove('active');
                            dislikeBtn.classList.remove('active');
                        }
                    }
                });

                dislikeBtn.addEventListener('click', async () => {
                    const result = await handleVote(menuName, menuDate, 'DISLIKE');
                    if (result) {
                        likeCountSpan.textContent = result.likeCount || 0;
                        dislikeCountSpan.textContent = result.dislikeCount || 0;
                        
                        // í™œì„± ìƒíƒœ ì—…ë°ì´íŠ¸
                        if (result.currentVote === 'DISLIKE') {
                            dislikeBtn.classList.add('active');
                            likeBtn.classList.remove('active');
                        } else {
                            likeBtn.classList.remove('active');
                            dislikeBtn.classList.remove('active');
                        }
                    }
                });
            }
        }

        // ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ í´ë¦­ ì‹œ ì¢‹ì•„ìš”/ì‹«ì–´ìš” í† ê¸€
        function setupMobileMenuToggle() {
            // ëª¨ë°”ì¼ì¸ì§€ í™•ì¸ (768px ì´í•˜)
            if (window.innerWidth <= 768) {
                const menuContainers = document.querySelectorAll('.menu-item-container');
                
                menuContainers.forEach(container => {
                    // ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    const voteContainer = container.querySelector('.menu-vote-container');
                    if (voteContainer) {
                        // ì´ë¯¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸
                        if (container.dataset.toggleSetup === 'true') {
                            return; // ì´ë¯¸ ì„¤ì •ë¨
                        }
                        container.dataset.toggleSetup = 'true';
                        
                        // ì»¨í…Œì´ë„ˆ ì „ì²´ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ (ë©”ë‰´ëª… í´ë¦­ ì‹œ)
                        container.addEventListener('click', function(e) {
                            // ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ í´ë¦­ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ë™ì‘
                            if (!e.target.closest('.vote-btn')) {
                                e.stopPropagation();

                                // show-votes ê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì¶”ê°€
                                if (!container.classList.contains('show-votes')) {
                                    container.classList.add('show-votes');
                                }
                            }
                        });
                        
                        // ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                        const voteButtons = voteContainer.querySelectorAll('.vote-btn');
                        voteButtons.forEach(btn => {
                            btn.addEventListener('click', function(e) {
                                e.stopPropagation();
                            });
                        });
                    }
                });
            }
        }

        // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ëª¨ë°”ì¼ í† ê¸€ ê¸°ëŠ¥ ì¬ì„¤ì •
        function handleResize() {
            autoResizeText();
            // ëª¨ë°”ì¼ì´ ì•„ë‹ˆë©´ ëª¨ë“  show-votes í´ë˜ìŠ¤ ì œê±°
            if (window.innerWidth > 768) {
                document.querySelectorAll('.menu-item-container.show-votes').forEach(container => {
                    container.classList.remove('show-votes');
                });
            }
        }

        // DOMì´ ëª¨ë‘ ë¡œë“œëœ í›„ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', () => {
            // 1) ë¨¼ì € ë‚´ìš© ì—†ëŠ” <tr>ì„ ì œê±°
            removeEmptyRows();
            // 2) ê·¸ë¦¬ê³  í°íŠ¸ ìë™ ë¦¬ì‚¬ì´ì¦ˆ ì²˜ë¦¬
            autoResizeText();
            // 3) ì¢‹ì•„ìš”/ì‹«ì–´ìš” ì´ˆê¸°í™” (ì„œë²„ ë°ì´í„° ì‚¬ìš©, API í˜¸ì¶œ ì—†ìŒ)
            initializeVotes();
            // 4) ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ ì„¤ì • (has-vote í´ë˜ìŠ¤ê°€ ì¶”ê°€ëœ í›„)
            setupMobileMenuToggle();
        });
        window.addEventListener('resize', handleResize);
    </script>
</div>
</body>
</html>
