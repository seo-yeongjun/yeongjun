<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout" layout:decorate="~{ajeGag/layout}">
<head>
    <title th:text="${title} ?: 'ì•„ì¬ê°œê·¸ ë°•ë¬¼ê´€'">í™ˆ í˜ì´ì§€</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <style>
        /* Carousel ì»¨í…Œì´ë„ˆ: ì „ì²´ í™”ë©´ ë„ˆë¹„ ì ìš© */
        #carouselContainer {
            position: relative;
            overflow: hidden;
            width: 100vw; /* ì „ì²´ ë·°í¬íŠ¸ ë„ˆë¹„ */
            height: 100%;
        }
        /* ìŠ¬ë¼ì´ë“œë¥¼ flexë¡œ ë°°ì¹˜ */
        #divList {
            display: flex;
            height: 100%;
            transition: transform 0.5s ease-in-out;
        }
        /* ê° ìŠ¬ë¼ì´ë“œì˜ í­ì„ ë·°í¬íŠ¸ í¬ê¸°ë¡œ ì„¤ì • */
        .carousel-item {
            width: 100vw;
            flex-shrink: 0;
        }
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.4);
            color: white;
            border: none;
            padding: 8px;
            cursor: pointer;
            z-index: 55;
        }
        #prevButton { left: 10px; }
        #nextButton { right: 10px; }
        /* Header ìŠ¬ë¼ì´ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
        .header-slide {
            position: relative;
            height: 100%;
            color: white;
        }
        .header-slide img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
        .header-slide .overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.6);
            z-index: 0;
        }
        .header-slide .content {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 0 1rem;
        }
        /* í…ìŠ¤íŠ¸ ê·¸ë¼ë°ì´ì…˜ */
        h1 {
            background: linear-gradient(to right, #917b30, #EF4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 {
            background: linear-gradient(to right, #0baa00, #0c5fdd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ck.ck-editor {
            min-height: 62vh;
        }
        .ck-editor__editable{
            min-height: 62vh;
        }
    </style>
    <script th:if="${isAdmin}" src="/ckeditor5/ckeditor5.umd.js"></script>
</head>
<body>
<div layout:fragment="content">
    <!-- Carousel ì˜ì—­: header ìŠ¬ë¼ì´ë“œ(ì²«ë²ˆì§¸)ì™€ ë™ì  ìŠ¬ë¼ì´ë“œ, end ìŠ¬ë¼ì´ë“œ(ë§ˆì§€ë§‰) -->
    <section id="carouselContainer">
        <button id="prevButton" class="carousel-nav" aria-label="ì´ì „">â€¹</button>
        <div id="divList">
            <!-- ì²«ë²ˆì§¸ ìŠ¬ë¼ì´ë“œ: Header ì½˜í…ì¸  -->
            <div class="carousel-item header-slide">
                <img src="/ajeGag/daemoon.jpg" alt="banner">
                <div class="overlay"></div>
                <div class="content flex flex-col items-center justify-center h-full">
                    <h1 class="text-4xl font-extrabold">ì•„ì¬ê°œê·¸ ë°•ë¬¼ê´€</h1>
                    <h2 class="text-2xl font-extrabold mt-4">
                        ì´ ê³µê°„ì€ ì›ƒìŒ ì•Œë ‰ì‚°ë¦¬ì•„ ë„ì„œê´€ì„ í‘œë°©í•©ë‹ˆë‹¤.<br>
                        ì›ƒìŒ ì¬íŒê´€ì¸ ì„œì˜ì¤€ì´ ì§ì ‘ ì—„ì„ í•œ ì›ƒê¸´ ì•„ì¬ê°œê·¸ì™€ ì§¤ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”.
                    </h2>
                    <button id="humorDataSubmit" type="button" class="mt-6 px-4 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500">
                        ì¬íŒê´€ì—ê²Œ ìë£Œì œê³µí•˜ê¸°
                    </button>
                    <!-- ê´€ë¦¬ì ê¶Œí•œì¼ ë•Œë§Œ ìë£Œ ì‘ì„±í•˜ê¸° ë²„íŠ¼ ë³´ì„ -->
                    <button id="humorWrite" type="button" class="mt-6 px-4 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500"
                            th:if="${isAdmin}">
                        ìë£Œ ì‘ì„±í•˜ê¸°
                    </button>
                    <p id="swipeInstruction" class="mt-2 text-sm" style="background-color: rgb(160 7 247 / 50%)">
                        ì¢Œìš°ë¡œ ìŠ¤ì™€ì´í”„ í•˜ê±°ë‚˜ ì¢Œìš° ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
                    </p>
                </div>
            </div>
        </div>
        <button id="nextButton" class="carousel-nav" aria-label="ë‹¤ìŒ">â€º</button>
    </section>

    <!-- ìë£Œ ì œì¶œ ëª¨ë‹¬ (ê¸°ë³¸ ìˆ¨ê¹€) -->
    <div id="humorDataSubmitModal" class="z-100 fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded shadow-lg w-11/12 md:w-1/2">
            <h3 class="text-2xl font-bold mb-4">ìë£Œ ì œê³µí•˜ê¸°</h3>
            <form id="submitHumorForm">
<!--                <div class="mb-4">-->
<!--                    <label for="humorTitle" class="block text-gray-700 mb-2">ì œëª©</label>-->
<!--                    <input id="humorTitle" type="text" class="w-full border border-gray-300 p-2 rounded" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">-->
<!--                </div>-->
<!--                <div class="mb-4">-->
<!--                    <label for="humorContent" class="block text-gray-700 mb-2">ë‚´ìš©</label>-->
<!--                    <textarea id="humorContent" class="w-full border border-gray-300 p-2 rounded" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" rows="4"></textarea>-->
<!--                </div>-->
<!--                <div class="flex justify-end">-->
<!--                <button type="button" id="closeModal" class="mr-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">-->
<!--                    ì·¨ì†Œ-->
<!--                </button>-->
<!--                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">-->
<!--                        ì œì¶œ-->
<!--                    </button>-->
<!--                </div>-->
                ì•„ì§, ìë£Œ ì œê³µì€ ë°›ê³  ìˆì§€ ì•Šì•„ìš”.
                <button type="button" id="closeModal" class="mr-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    ë‹«ê¸°
                </button>
            </form>
        </div>
    </div>

    <div id="adminWriteModal" class="z-100 fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 hidden" th:if="${isAdmin}">
        <div class="bg-white w-full h-full p-6 overflow-auto relative">
            <!-- ìš°ì¸¡ ìƒë‹¨ ë‹«ê¸° ë²„íŠ¼ -->
            <button type="button" id="closeAdminModal" class="absolute top-4 right-4 bg-gray-500 text-white px-3 py-2 rounded hover:bg-gray-600">
                ë‹«ê¸°
            </button>
            <h3 class="text-3xl font-bold mb-6 text-center">ìë£Œ ì‘ì„±í•˜ê¸°</h3>
            <form id="adminWriteForm">
                <div class="mb-4">
                    <label for="adminTitle" class="block text-gray-700 mb-2">ì œëª©</label>
                    <input id="adminTitle" name="title" type="text" class="w-full border border-gray-300 p-2 rounded" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="mb-4">
                    <label for="adminDetail" class="block text-gray-700 mb-2">ë‚´ìš© (HTML)</label>
                    <!-- CKEditorê°€ adminDetail textareaë¥¼ ëŒ€ì²´í•©ë‹ˆë‹¤ -->
                    <textarea id="adminDetail" name="detail" class="w-full border border-gray-300 p-2 rounded h-96" placeholder="ë‚´ìš©ì„ HTML í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        ì œì¶œ
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // ëª¨ë‹¬ ê´€ë ¨ ê¸°ëŠ¥ (ì¼ë°˜ ì‚¬ìš©ììš©)
        const humorDataSubmitButton = document.getElementById('humorDataSubmit');
        const humorDataSubmitModal = document.getElementById('humorDataSubmitModal');
        const closeModalButton = document.getElementById('closeModal');

        humorDataSubmitButton.addEventListener('click', () => {
            humorDataSubmitModal.classList.remove('hidden');
        });
        closeModalButton.addEventListener('click', () => {
            humorDataSubmitModal.classList.add('hidden');
        });
        humorDataSubmitModal.addEventListener('click', (e) => {
            if (e.target === humorDataSubmitModal) {
                humorDataSubmitModal.classList.add('hidden');
            }
        });

        // Carousel ê´€ë ¨ ê¸°ëŠ¥
        const divList = document.getElementById('divList');
        let currentIndex = 0; // 0: header ìŠ¬ë¼ì´ë“œ, 1~items.length: ë™ì  ìŠ¬ë¼ì´ë“œ, ë§ˆì§€ë§‰: end ìŠ¬ë¼ì´ë“œ
        let items = [];     // /ajeGag/getListë¡œ ë°›ì•„ì˜¨ ì•„ì´ë”” ëª©ë¡

        // ì…”í”Œ í•¨ìˆ˜ (Fisher-Yates)
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // /ajeGag/getListë¥¼ í˜¸ì¶œí•´ id ëª©ë¡ì„ ë¡œë“œ í›„ ì…”í”Œ
        fetch('/ajeGag/getList')
            .then(response => response.json())
            .then(data => {
                items = data;
                shuffle(items);
            })
            .catch(err => {
                console.error('Error fetching humor list:', err);
            });

        // ë™ì  ìŠ¬ë¼ì´ë“œ ë¡œë“œ í•¨ìˆ˜: ì¸ë±ìŠ¤ì— í•´ë‹¹í•˜ëŠ” ì½˜í…ì¸ ë¥¼ ê°€ì ¸ì™€ ìŠ¬ë¼ì´ë“œë¡œ ì¶”ê°€
        function loadSlide(index) {
            if (index === 0) return; // 0ì€ header ìŠ¬ë¼ì´ë“œ
            // ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ë“œ (end ìŠ¬ë¼ì´ë“œ)
            if (index === items.length + 1) {
                const slide = document.createElement('div');
                slide.classList.add('carousel-item', 'flex', 'items-center', 'justify-center', 'end-slide');
                slide.innerHTML = `
        <div class="end-slide-content text-center p-6">
            <h2 class="text-3xl font-bold mb-4">ì˜¤ëŠ˜ë„ ì›ƒìŒì´ ê°€ë“!</h2>
            <p class="mb-2">ì§€ê¸ˆê¹Œì§€ ëª¨ì•„ì˜¨ ëª¨ë“  ìë£Œë¥¼ ë‹¤ ë³´ì…¨ì–´ìš”.</p>
            <p class="mb-2">ë‹¤ìŒì—ëŠ” ì¬íŒê´€ ì˜ì¤€ì´ ë” ë§ì€ ìë£Œë¥¼ ì¶”ê°€í•´ ë’€ê¸¸ ë°”ë˜ë³´ì£ !</p>
            <button id="restartCarousel" class="mt-4 px-4 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    `;
                divList.appendChild(slide);
                updateCarousel();

                // "ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ ì²« ìŠ¬ë¼ì´ë“œë¡œ ì´ë™
                slide.querySelector('#restartCarousel').addEventListener('click', () => {
                    currentIndex = 0;
                    updateCarousel();
                });
                return;
            }

            // ë™ì  ì½˜í…ì¸  ìŠ¬ë¼ì´ë“œ: header ìŠ¬ë¼ì´ë“œ ë‹¤ìŒë¶€í„° index 1 ~ items.length
            const itemIndex = index - 1;
            if (itemIndex < 0 || itemIndex >= items.length) return;
            const item = items[itemIndex];
            fetch('/ajeGag/getHumor?id=' + item.ajegag_text_id)
                .then(response => response.json())
                .then(content => {
                    const slide = document.createElement('div');
                    slide.classList.add('carousel-item', 'flex', 'items-center', 'justify-center', 'p-4', 'bg-white', 'bg-opacity-80', 'rounded');
                    slide.innerHTML = `
                        <div>
                            <h3>${content.title}</h3>
                            <p>${content.detail}</p>
                            <p><small>${content.created_at ? content.created_at : ''}</small></p>
                        </div>
                    `;
                    divList.appendChild(slide);
                    updateCarousel();
                })
                .catch(err => {
                    console.error('Error fetching humor content:', err);
                });
        }

        // carousel ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ + ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì œì–´
        function updateCarousel() {
            const slideWidth = window.innerWidth;
            const offset = -currentIndex * slideWidth;
            divList.style.transform = 'translateX(' + offset + 'px)';

            // ì´ ìŠ¬ë¼ì´ë“œ ìˆ˜: header(1) + ë™ì  ìŠ¬ë¼ì´ë“œ(items.length) + end(1)
            const totalSlides = items.length + 2;
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');

            // ì²« ìŠ¬ë¼ì´ë“œì—ì„œëŠ” ì™¼ìª½ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            prevButton.style.display = currentIndex === 0 ? 'none' : 'block';
            // ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ë“œì—ì„œëŠ” ì˜¤ë¥¸ìª½ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            nextButton.style.display = currentIndex === totalSlides - 1 ? 'none' : 'block';
        }

        // "ë‹¤ìŒ" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('nextButton').addEventListener('click', () => {
            const totalSlides = items.length + 2;
            if (currentIndex < totalSlides - 1) {
                currentIndex++;
                if (divList.children.length <= currentIndex) {
                    loadSlide(currentIndex);
                } else {
                    updateCarousel();
                }
            }
        });

        // "ì´ì „" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.getElementById('prevButton').addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                updateCarousel();
            }
        });

        // ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥
        let startX = 0;
        let isSwiping = false;

        divList.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isSwiping = true;
        });
        divList.addEventListener('touchmove', (e) => {
            if (!isSwiping) return;
            const currentX = e.touches[0].clientX;
            const diffX = startX - currentX;
            const totalSlides = items.length + 2;
            if (diffX > 50 && currentIndex < totalSlides - 1) { // ì™¼ìª½ ìŠ¤ì™€ì´í”„ ì‹œ
                currentIndex++;
                if (divList.children.length <= currentIndex) {
                    loadSlide(currentIndex);
                } else {
                    updateCarousel();
                }
                isSwiping = false;
            } else if (diffX < -50 && currentIndex > 0) { // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ ì‹œ
                currentIndex--;
                updateCarousel();
                isSwiping = false;
            }
        });
        divList.addEventListener('touchend', () => {
            isSwiping = false;
        });

        window.addEventListener('resize', updateCarousel);
    </script>

    <script th:if="${isAdmin}">
        const {
            Alignment,
            AutoImage,
            Autosave,
            Bold,
            Essentials,
            FontBackgroundColor,
            FontColor,
            FontFamily,
            FontSize,
            FullPage,
            GeneralHtmlSupport,
            HorizontalLine,
            HtmlComment,
            ImageBlock,
            ImageEditing,
            ImageInsert,
            ImageInsertViaUrl,
            ImageResize,
            ImageStyle,
            ImageToolbar,
            ImageUpload,
            ImageUtils,
            Link,
            List,
            ListProperties,
            MediaEmbed,
            Paragraph,
            PasteFromOffice,
            SimpleUploadAdapter,
            SourceEditing,
            SpecialCharacters,
            SpecialCharactersArrows,
            SpecialCharactersCurrency,
            SpecialCharactersEssentials,
            SpecialCharactersLatin,
            SpecialCharactersMathematical,
            SpecialCharactersText,
            Strikethrough,
            Table,
            TableCaption,
            TableCellProperties,
            TableColumnResize,
            TableProperties,
            TableToolbar,
            Underline,
            ClassicEditor
        } = CKEDITOR;

        class MyUploadAdapter {
            constructor(loader) {
                this.loader = loader;
            }

            upload() {
                return this.loader.file.then(file => new Promise((resolve, reject) => {
                    const data = new FormData();
                    data.append('upload', file);

                    fetch('/ajeGag/uploadFile', {
                        method: 'POST',
                        body: data
                    })
                        .then(response => response.json())
                        .then(result => {
                            // CKEditorëŠ” { default: "ì´ë¯¸ì§€ URL" } í˜•íƒœë¥¼ ê¸°ëŒ€
                            resolve({ default: result.url });
                        })
                        .catch(error => {
                            console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                            reject('Upload failed');
                        });
                }));
            }

            abort() {
                // í•„ìš”ì‹œ ì—…ë¡œë“œ ì¤‘ë‹¨ ê¸°ëŠ¥ êµ¬í˜„
            }
        }

        const editorConfig = {
            toolbar: {
                items: [
                    'sourceEditing',
                    '|',
                    'fontSize',
                    'fontFamily',
                    'fontColor',
                    'fontBackgroundColor',
                    '|',
                    'bold',
                    'underline',
                    'strikethrough',
                    '|',
                    'specialCharacters',
                    'horizontalLine',
                    'link',
                    'insertImage',
                    'mediaEmbed',
                    'insertTable',
                    '|',
                    'alignment',
                    '|',
                    'bulletedList',
                    'numberedList'
                ],
                shouldNotGroupWhenFull: true
            },
            fontFamily: {
                supportAllValues: true
            },
            fontSize: {
                options: [10, 12, 14, 'default', 18, 20, 22],
                supportAllValues: true
            },
            htmlSupport: {
                allow: [
                    {
                        name: /^.*$/,
                        styles: true,
                        attributes: true,
                        classes: true
                    }
                ]
            },
            image: {
                toolbar: [
                    'imageTextAlternative',
                    '|',
                    'imageStyle:alignBlockLeft',
                    'imageStyle:block',
                    'imageStyle:alignBlockRight',
                    '|',
                    'resizeImage'
                ],
                styles: {
                    options: ['alignBlockLeft', 'block', 'alignBlockRight']
                }
            },
            initialData:
                '<h2>Congratulations on setting up CKEditor 5! ğŸ‰</h2>\n<p>\n\tYou\'ve successfully created a CKEditor 5 project. This powerful text editor\n\twill enhance your application, enabling rich text editing capabilities that\n\tare customizable and easy to use.\n</p>\n<h3>What\'s next?</h3>\n<ol>\n\t<li>\n\t\t<strong>Integrate into your app</strong>: time to bring the editing into\n\t\tyour application. Take the code you created and add to your application.\n\t</li>\n\t<li>\n\t\t<strong>Explore features:</strong> Experiment with different plugins and\n\t\ttoolbar options to discover what works best for your needs.\n\t</li>\n\t<li>\n\t\t<strong>Customize your editor:</strong> Tailor the editor\'s\n\t\tconfiguration to match your application\'s style and requirements. Or\n\t\teven write your plugin!\n\t</li>\n</ol>\n<p>\n\tKeep experimenting, and don\'t hesitate to push the boundaries of what you\n\tcan achieve with CKEditor 5. Your feedback is invaluable to us as we strive\n\tto improve and evolve. Happy editing!\n</p>\n<h3>Helpful resources</h3>\n<ul>\n\t<li>ğŸ“ <a href="https://portal.ckeditor.com/checkout?plan=free">Trial sign up</a>,</li>\n\t<li>ğŸ“• <a href="https://ckeditor.com/docs/ckeditor5/latest/installation/index.html">Documentation</a>,</li>\n\t<li>â­ï¸ <a href="https://github.com/ckeditor/ckeditor5">GitHub</a> (star us if you can!),</li>\n\t<li>ğŸ  <a href="https://ckeditor.com">CKEditor Homepage</a>,</li>\n\t<li>ğŸ§‘â€ğŸ’» <a href="https://ckeditor.com/ckeditor-5/demo/">CKEditor 5 Demos</a>,</li>\n</ul>\n<h3>Need help?</h3>\n<p>\n\tSee this text, but the editor is not starting up? Check the browser\'s\n\tconsole for clues and guidance. It may be related to an incorrect license\n\tkey if you use premium features or another feature-related requirement. If\n\tyou cannot make it work, file a GitHub issue, and we will help as soon as\n\tpossible!\n</p>\n',
            language: 'ko',
            licenseKey: 'GPL',
            link: {
                addTargetToExternalLinks: true,
                defaultProtocol: 'https://',
                decorators: {
                    toggleDownloadable: {
                        mode: 'manual',
                        label: 'Downloadable',
                        attributes: {
                            download: 'file'
                        }
                    }
                }
            },
            list: {
                properties: {
                    styles: true,
                    startIndex: true,
                    reversed: true
                }
            },
            placeholder: 'Type or paste your content here!',
            table: {
                contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells', 'tableProperties', 'tableCellProperties']
            },
            extraPlugins: [
                editor => {
                    editor.plugins.get('FileRepository').createUploadAdapter = loader => {
                        return new MyUploadAdapter(loader);
                    };
                }
            ]
        };

        ClassicEditor.create(document.querySelector('#adminDetail'), editorConfig)
            .then(editor => {
                console.log('CKEditor 5 is ready!', editor);
            })
            .catch(error => {
                console.error('CKEditor init failed:', error);
            });

    </script>
</div>
</body>
</html>
