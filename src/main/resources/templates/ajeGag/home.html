<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout" layout:decorate="~{ajeGag/layout}">
<head>
    <title th:text="${title} ?: '아재개그 박물관'">홈 페이지</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <style>
        /* Carousel 컨테이너: 전체 화면 너비 적용 */
        #carouselContainer {
            position: relative;
            overflow: hidden;
            width: 100vw; /* 전체 뷰포트 너비 */
            height: 100%;
        }
        /* 슬라이드를 flex로 배치 */
        #divList {
            display: flex;
            height: 100%;
            transition: transform 0.5s ease-in-out;
        }
        /* 각 슬라이드의 폭을 뷰포트 크기로 설정 */
        .carousel-item {
            width: 100vw;
            flex-shrink: 0;
        }
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.4);
            color: white;
            border: none;
            padding: 8px;
            cursor: pointer;
            z-index: 55;
        }
        #prevButton { left: 10px; }
        #nextButton { right: 10px; }
        /* Header 슬라이드 전용 스타일 */
        .header-slide {
            position: relative;
            height: 100%;
            color: white;
        }
        .header-slide img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
        .header-slide .overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.6);
            z-index: 0;
        }
        .header-slide .content {
            position: relative;
            z-index: 10;
            text-align: center;
            padding: 0 1rem;
        }
        /* 텍스트 그라데이션 */
        h1 {
            background: linear-gradient(to right, #917b30, #EF4444);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 {
            background: linear-gradient(to right, #0baa00, #0c5fdd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .ck.ck-editor {
            min-height: 62vh;
        }
        .ck-editor__editable{
            min-height: 62vh;
        }
    </style>
    <script th:if="${isAdmin}" src="/ckeditor5/ckeditor5.umd.js"></script>
</head>
<body>
<div layout:fragment="content">
    <!-- Carousel 영역: header 슬라이드(첫번째)와 동적 슬라이드, end 슬라이드(마지막) -->
    <section id="carouselContainer">
        <button id="prevButton" class="carousel-nav" aria-label="이전">‹</button>
        <div id="divList">
            <!-- 첫번째 슬라이드: Header 콘텐츠 -->
            <div class="carousel-item header-slide">
                <img src="/ajeGag/daemoon.jpg" alt="banner">
                <div class="overlay"></div>
                <div class="content flex flex-col items-center justify-center h-full">
                    <h1 class="text-4xl font-extrabold">아재개그 박물관</h1>
                    <h2 class="text-2xl font-extrabold mt-4">
                        이 공간은 웃음 알렉산리아 도서관을 표방합니다.<br>
                        웃음 재판관인 서영준이 직접 엄선한 웃긴 아재개그와 짤들을 만나보세요.
                    </h2>
                    <button id="humorDataSubmit" type="button" class="mt-6 px-4 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500">
                        재판관에게 자료제공하기
                    </button>
                    <!-- 관리자 권한일 때만 자료 작성하기 버튼 보임 -->
                    <button id="humorWrite" type="button" class="mt-6 px-4 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500"
                            th:if="${isAdmin}">
                        자료 작성하기
                    </button>
                    <p id="swipeInstruction" class="mt-2 text-sm" style="background-color: rgb(160 7 247 / 50%)">
                        좌우로 스와이프 하거나 좌우 버튼을 클릭하세요.
                    </p>
                </div>
            </div>
        </div>
        <button id="nextButton" class="carousel-nav" aria-label="다음">›</button>
    </section>

    <!-- 자료 제출 모달 (기본 숨김) -->
    <div id="humorDataSubmitModal" class="z-100 fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white p-6 rounded shadow-lg w-11/12 md:w-1/2">
            <h3 class="text-2xl font-bold mb-4">자료 제공하기</h3>
            <form id="submitHumorForm">
<!--                <div class="mb-4">-->
<!--                    <label for="humorTitle" class="block text-gray-700 mb-2">제목</label>-->
<!--                    <input id="humorTitle" type="text" class="w-full border border-gray-300 p-2 rounded" placeholder="제목을 입력하세요">-->
<!--                </div>-->
<!--                <div class="mb-4">-->
<!--                    <label for="humorContent" class="block text-gray-700 mb-2">내용</label>-->
<!--                    <textarea id="humorContent" class="w-full border border-gray-300 p-2 rounded" placeholder="내용을 입력하세요" rows="4"></textarea>-->
<!--                </div>-->
<!--                <div class="flex justify-end">-->
<!--                <button type="button" id="closeModal" class="mr-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">-->
<!--                    취소-->
<!--                </button>-->
<!--                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">-->
<!--                        제출-->
<!--                    </button>-->
<!--                </div>-->
                아직, 자료 제공은 받고 있지 않아요.
                <button type="button" id="closeModal" class="mr-2 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    닫기
                </button>
            </form>
        </div>
    </div>

    <div id="adminWriteModal" class="z-100 fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 hidden" th:if="${isAdmin}">
        <div class="bg-white w-full h-full p-6 overflow-auto relative">
            <!-- 우측 상단 닫기 버튼 -->
            <button type="button" id="closeAdminModal" class="absolute top-4 right-4 bg-gray-500 text-white px-3 py-2 rounded hover:bg-gray-600">
                닫기
            </button>
            <h3 class="text-3xl font-bold mb-6 text-center">자료 작성하기</h3>
            <form id="adminWriteForm">
                <div class="mb-4">
                    <label for="adminTitle" class="block text-gray-700 mb-2">제목</label>
                    <input id="adminTitle" name="title" type="text" class="w-full border border-gray-300 p-2 rounded" placeholder="제목을 입력하세요">
                </div>
                <div class="mb-4">
                    <label for="adminDetail" class="block text-gray-700 mb-2">내용 (HTML)</label>
                    <!-- CKEditor가 adminDetail textarea를 대체합니다 -->
                    <textarea id="adminDetail" name="detail" class="w-full border border-gray-300 p-2 rounded h-96" placeholder="내용을 HTML 형식으로 입력하세요"></textarea>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        제출
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // 모달 관련 기능 (일반 사용자용)
        const humorDataSubmitButton = document.getElementById('humorDataSubmit');
        const humorDataSubmitModal = document.getElementById('humorDataSubmitModal');
        const closeModalButton = document.getElementById('closeModal');

        humorDataSubmitButton.addEventListener('click', () => {
            humorDataSubmitModal.classList.remove('hidden');
        });
        closeModalButton.addEventListener('click', () => {
            humorDataSubmitModal.classList.add('hidden');
        });
        humorDataSubmitModal.addEventListener('click', (e) => {
            if (e.target === humorDataSubmitModal) {
                humorDataSubmitModal.classList.add('hidden');
            }
        });

        // Carousel 관련 기능
        const divList = document.getElementById('divList');
        let currentIndex = 0; // 0: header 슬라이드, 1~items.length: 동적 슬라이드, 마지막: end 슬라이드
        let items = [];     // /ajeGag/getList로 받아온 아이디 목록

        // 셔플 함수 (Fisher-Yates)
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // /ajeGag/getList를 호출해 id 목록을 로드 후 셔플
        fetch('/ajeGag/getList')
            .then(response => response.json())
            .then(data => {
                items = data;
                shuffle(items);
            })
            .catch(err => {
                console.error('Error fetching humor list:', err);
            });

        // 동적 슬라이드 로드 함수: 인덱스에 해당하는 콘텐츠를 가져와 슬라이드로 추가
        function loadSlide(index) {
            if (index === 0) return; // 0은 header 슬라이드
            // 마지막 슬라이드 (end 슬라이드)
            if (index === items.length + 1) {
                const slide = document.createElement('div');
                slide.classList.add('carousel-item', 'flex', 'items-center', 'justify-center', 'end-slide');
                slide.innerHTML = `
        <div class="end-slide-content text-center p-6">
            <h2 class="text-3xl font-bold mb-4">오늘도 웃음이 가득!</h2>
            <p class="mb-2">지금까지 모아온 모든 자료를 다 보셨어요.</p>
            <p class="mb-2">다음에는 재판관 영준이 더 많은 자료를 추가해 뒀길 바래보죠!</p>
            <button id="restartCarousel" class="mt-4 px-4 py-2 bg-yellow-400 text-black rounded hover:bg-yellow-500">처음으로 돌아가기</button>
        </div>
    `;
                divList.appendChild(slide);
                updateCarousel();

                // "처음으로 돌아가기" 버튼 클릭 시 첫 슬라이드로 이동
                slide.querySelector('#restartCarousel').addEventListener('click', () => {
                    currentIndex = 0;
                    updateCarousel();
                });
                return;
            }

            // 동적 콘텐츠 슬라이드: header 슬라이드 다음부터 index 1 ~ items.length
            const itemIndex = index - 1;
            if (itemIndex < 0 || itemIndex >= items.length) return;
            const item = items[itemIndex];
            fetch('/ajeGag/getHumor?id=' + item.ajegag_text_id)
                .then(response => response.json())
                .then(content => {
                    const slide = document.createElement('div');
                    slide.classList.add('carousel-item', 'flex', 'items-center', 'justify-center', 'p-4', 'bg-white', 'bg-opacity-80', 'rounded');
                    slide.innerHTML = `
                        <div>
                            <h3>${content.title}</h3>
                            <p>${content.detail}</p>
                            <p><small>${content.created_at ? content.created_at : ''}</small></p>
                        </div>
                    `;
                    divList.appendChild(slide);
                    updateCarousel();
                })
                .catch(err => {
                    console.error('Error fetching humor content:', err);
                });
        }

        // carousel 위치 업데이트 함수 + 네비게이션 버튼 제어
        function updateCarousel() {
            const slideWidth = window.innerWidth;
            const offset = -currentIndex * slideWidth;
            divList.style.transform = 'translateX(' + offset + 'px)';

            // 총 슬라이드 수: header(1) + 동적 슬라이드(items.length) + end(1)
            const totalSlides = items.length + 2;
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');

            // 첫 슬라이드에서는 왼쪽 버튼 숨기기
            prevButton.style.display = currentIndex === 0 ? 'none' : 'block';
            // 마지막 슬라이드에서는 오른쪽 버튼 숨기기
            nextButton.style.display = currentIndex === totalSlides - 1 ? 'none' : 'block';
        }

        // "다음" 버튼 클릭 이벤트
        document.getElementById('nextButton').addEventListener('click', () => {
            const totalSlides = items.length + 2;
            if (currentIndex < totalSlides - 1) {
                currentIndex++;
                if (divList.children.length <= currentIndex) {
                    loadSlide(currentIndex);
                } else {
                    updateCarousel();
                }
            }
        });

        // "이전" 버튼 클릭 이벤트
        document.getElementById('prevButton').addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                updateCarousel();
            }
        });

        // 모바일 스와이프 기능
        let startX = 0;
        let isSwiping = false;

        divList.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isSwiping = true;
        });
        divList.addEventListener('touchmove', (e) => {
            if (!isSwiping) return;
            const currentX = e.touches[0].clientX;
            const diffX = startX - currentX;
            const totalSlides = items.length + 2;
            if (diffX > 50 && currentIndex < totalSlides - 1) { // 왼쪽 스와이프 시
                currentIndex++;
                if (divList.children.length <= currentIndex) {
                    loadSlide(currentIndex);
                } else {
                    updateCarousel();
                }
                isSwiping = false;
            } else if (diffX < -50 && currentIndex > 0) { // 오른쪽 스와이프 시
                currentIndex--;
                updateCarousel();
                isSwiping = false;
            }
        });
        divList.addEventListener('touchend', () => {
            isSwiping = false;
        });

        window.addEventListener('resize', updateCarousel);
    </script>

    <script th:if="${isAdmin}">
        const {
            Alignment,
            AutoImage,
            Autosave,
            Bold,
            Essentials,
            FontBackgroundColor,
            FontColor,
            FontFamily,
            FontSize,
            FullPage,
            GeneralHtmlSupport,
            HorizontalLine,
            HtmlComment,
            ImageBlock,
            ImageEditing,
            ImageInsert,
            ImageInsertViaUrl,
            ImageResize,
            ImageStyle,
            ImageToolbar,
            ImageUpload,
            ImageUtils,
            Link,
            List,
            ListProperties,
            MediaEmbed,
            Paragraph,
            PasteFromOffice,
            SimpleUploadAdapter,
            SourceEditing,
            SpecialCharacters,
            SpecialCharactersArrows,
            SpecialCharactersCurrency,
            SpecialCharactersEssentials,
            SpecialCharactersLatin,
            SpecialCharactersMathematical,
            SpecialCharactersText,
            Strikethrough,
            Table,
            TableCaption,
            TableCellProperties,
            TableColumnResize,
            TableProperties,
            TableToolbar,
            Underline,
            ClassicEditor
        } = CKEDITOR;

        class MyUploadAdapter {
            constructor(loader) {
                this.loader = loader;
            }

            upload() {
                return this.loader.file.then(file => new Promise((resolve, reject) => {
                    const data = new FormData();
                    data.append('upload', file);

                    fetch('/ajeGag/uploadFile', {
                        method: 'POST',
                        body: data
                    })
                        .then(response => response.json())
                        .then(result => {
                            // CKEditor는 { default: "이미지 URL" } 형태를 기대
                            resolve({ default: result.url });
                        })
                        .catch(error => {
                            console.error('업로드 실패:', error);
                            reject('Upload failed');
                        });
                }));
            }

            abort() {
                // 필요시 업로드 중단 기능 구현
            }
        }

        const editorConfig = {
            toolbar: {
                items: [
                    'sourceEditing',
                    '|',
                    'fontSize',
                    'fontFamily',
                    'fontColor',
                    'fontBackgroundColor',
                    '|',
                    'bold',
                    'underline',
                    'strikethrough',
                    '|',
                    'specialCharacters',
                    'horizontalLine',
                    'link',
                    'insertImage',
                    'mediaEmbed',
                    'insertTable',
                    '|',
                    'alignment',
                    '|',
                    'bulletedList',
                    'numberedList'
                ],
                shouldNotGroupWhenFull: true
            },
            fontFamily: {
                supportAllValues: true
            },
            fontSize: {
                options: [10, 12, 14, 'default', 18, 20, 22],
                supportAllValues: true
            },
            htmlSupport: {
                allow: [
                    {
                        name: /^.*$/,
                        styles: true,
                        attributes: true,
                        classes: true
                    }
                ]
            },
            image: {
                toolbar: [
                    'imageTextAlternative',
                    '|',
                    'imageStyle:alignBlockLeft',
                    'imageStyle:block',
                    'imageStyle:alignBlockRight',
                    '|',
                    'resizeImage'
                ],
                styles: {
                    options: ['alignBlockLeft', 'block', 'alignBlockRight']
                }
            },
            initialData:
                '<h2>Congratulations on setting up CKEditor 5! 🎉</h2>\n<p>\n\tYou\'ve successfully created a CKEditor 5 project. This powerful text editor\n\twill enhance your application, enabling rich text editing capabilities that\n\tare customizable and easy to use.\n</p>\n<h3>What\'s next?</h3>\n<ol>\n\t<li>\n\t\t<strong>Integrate into your app</strong>: time to bring the editing into\n\t\tyour application. Take the code you created and add to your application.\n\t</li>\n\t<li>\n\t\t<strong>Explore features:</strong> Experiment with different plugins and\n\t\ttoolbar options to discover what works best for your needs.\n\t</li>\n\t<li>\n\t\t<strong>Customize your editor:</strong> Tailor the editor\'s\n\t\tconfiguration to match your application\'s style and requirements. Or\n\t\teven write your plugin!\n\t</li>\n</ol>\n<p>\n\tKeep experimenting, and don\'t hesitate to push the boundaries of what you\n\tcan achieve with CKEditor 5. Your feedback is invaluable to us as we strive\n\tto improve and evolve. Happy editing!\n</p>\n<h3>Helpful resources</h3>\n<ul>\n\t<li>📝 <a href="https://portal.ckeditor.com/checkout?plan=free">Trial sign up</a>,</li>\n\t<li>📕 <a href="https://ckeditor.com/docs/ckeditor5/latest/installation/index.html">Documentation</a>,</li>\n\t<li>⭐️ <a href="https://github.com/ckeditor/ckeditor5">GitHub</a> (star us if you can!),</li>\n\t<li>🏠 <a href="https://ckeditor.com">CKEditor Homepage</a>,</li>\n\t<li>🧑‍💻 <a href="https://ckeditor.com/ckeditor-5/demo/">CKEditor 5 Demos</a>,</li>\n</ul>\n<h3>Need help?</h3>\n<p>\n\tSee this text, but the editor is not starting up? Check the browser\'s\n\tconsole for clues and guidance. It may be related to an incorrect license\n\tkey if you use premium features or another feature-related requirement. If\n\tyou cannot make it work, file a GitHub issue, and we will help as soon as\n\tpossible!\n</p>\n',
            language: 'ko',
            licenseKey: 'GPL',
            link: {
                addTargetToExternalLinks: true,
                defaultProtocol: 'https://',
                decorators: {
                    toggleDownloadable: {
                        mode: 'manual',
                        label: 'Downloadable',
                        attributes: {
                            download: 'file'
                        }
                    }
                }
            },
            list: {
                properties: {
                    styles: true,
                    startIndex: true,
                    reversed: true
                }
            },
            placeholder: 'Type or paste your content here!',
            table: {
                contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells', 'tableProperties', 'tableCellProperties']
            },
            extraPlugins: [
                editor => {
                    editor.plugins.get('FileRepository').createUploadAdapter = loader => {
                        return new MyUploadAdapter(loader);
                    };
                }
            ]
        };

        ClassicEditor.create(document.querySelector('#adminDetail'), editorConfig)
            .then(editor => {
                console.log('CKEditor 5 is ready!', editor);
            })
            .catch(error => {
                console.error('CKEditor init failed:', error);
            });

    </script>
</div>
</body>
</html>
